{% extends 'base.html' %}
{% load i18n mptt_tags static widget_tweaks %}

{% block css %}{% include 'base/snippets/fullscreen.html' %}{% endblock %}
{% block title %}{{ essay.title }}{% endblock %}
{% comment %}<!-- load hitcount_tags get_hit_count_js_variables for essay as hitcount %}
{% get_hit_count for essay as tot_readers %}
<script src="{% static 'hitcount/jquery.postcsrf.js' %}"></script>
<script type="text/javascript">
  jQuery(document).ready(function($) {
    $.postCSRF("{{ hitcount.ajax_url }}", { hitcountPK : "{{ hitcount.pk }}" })
      .done(function(data){
        $('<i />').text(data.hit_counted).attr('id','hit-counted-value').appendTo('#hit-counted');
        $('#hit-response').text(data.hit_message);
    }).fail(function(data){
        console.log('POST failed');// console.log(data);
    });
  });
</script>-->{% endcomment %}
{% block content %}
<div ondblclick="exitFullscreen();">
<div class="font-c-serif max-w-md md:max-w-lg m-auto px-2">
  <div ondblclick="focusMode(document.documentElement);">
    {% if essay.image %}
    <div class="header mx-auto text-center mb-4"><img src="{{ essay.image.url }}" alt="{{ essay.slug }}" class="m-auto rounded"></div>
    {% endif %}
    <div class="border-t-2 border-b border-gray-400 py-3 rounded-lg text-center mb-4">
      <h1 class="text-4xl">{{ essay.title }}</h1>
      <div class="inline-flex items-center space-x-2 text-md my-3">
      {% if not essay.author_team and essay.author %}
        {% if essay.author == 'Team' or essay.author == 'team' %}
          <a href="{{ team_url }}" class="flex rounded-full ring-yellow-100 focus:ring-2 ring-offset-2 ring-offset-transparent focus:outline-none" data-tippy-content="{{ com }}" alt="{{ com }}'s logo" target="_blank">
          <svg class="fill-current mx-auto w-10 h-10 xl:w-12 xl:h-12"><use xlink:href="{% static 'img/svg-defs.svg' %}#clogo"></use></svg></a>
          <a class="un rounded ring-yellow-100 focus:ring-2 ring-offset-2 ring-offset-transparent focus:outline-none" href="{{ team_url }}" data-tippy-content="C-Team" target="_blank">{{ com }} team</a>
        {% else %}
          {% if essay.author.img %}
          <a href="{% if essay.author_url %}{{ essay.author_url }}{% else %}{% url 'author' slug=essay.author.slug %}{% endif %}" class="flex rounded-full ring-yellow-100 focus:ring-2 ring-offset-2 ring-offset-transparent focus:outline-none" target="_blank"><img class="t-img rounded-full w-10 h-10 bg-gradient-to-tl to-yellow-200 from-red-700 shadow" src="{{ essay.author.img.url }}" alt="{{ essay.author.slug }}"/></a>
          {% endif %}
        <a class="un rounded ring-yellow-100 focus:ring-2 ring-offset-2 ring-offset-transparent focus:outline-none" href="{% if essay.author_url %}{{ essay.author_url }}{% else %}{% url 'author' slug=essay.author.slug %}{% endif %}" target="_blank">{{ essay.author.name }}</a>
        {% endif %}
      {% endif %}
      {% if essay.author_team %}
      {% if essay.author_team.img %}
        <a href="{% url 'team:detail' slug=essay.author_team.slug %}" class="flex rounded-full ring-yellow-100 focus:ring-2 ring-offset-2 ring-offset-transparent focus:outline-none" target="_blank">
        <img class="t-img rounded-full w-10 h-10 shadow" src="{{ essay.author_team.img.url }}"></a>
      {% endif %}
      <a href="{% url 'team:detail' slug=essay.author_team.slug %}" class="un rounded ring-yellow-100 focus:ring-2 ring-offset-2 ring-offset-transparent focus:outline-none" target="_blank">{{ essay.author_team.name }}</a>
      {% else %}
      <span>Øutis</span>
      {% endif %}
      <span class="sep"></span>
      <span data-tippy-content="Publication date (years since the current form of humans evolved)">20{{ essay.updated|date:'Y-m-d' }}</span>
      </div>
      <div>{% if essay.audio %}
      {% include 'base/snippets/audio.html' with obj=essay %}
      {% endif %}</div>
      <div class="inline-flex space-x-5">
        <span class="text-sm text-gray-600">{% trans 'Doubleclick to focus' %}</span>
        {% include 'base/snippets/theme.html' %}
      </div>
    </div>

    {% if essay.abstract %}
    <div class="py-4 px-8 border-t-2 border-b border-gray-500 mt-3 mb-8 mx-auto">
      <p class="text-lg text-justify hyphens list-inside">{{ essay.abstract|safe }}</p>
    </div>
    {% endif %}

    <div class="border border-gray-300 shadow rounded-lg p-5 text-lg text-justify hyphens list-inside">
      {{ essay.text|safe }}
      {% if essay.img %}
      <div class="mt-2 mb-6"><img src="{{ essay.img.url }}" class="mx-auto rounded"></div>
      {% endif %}
      <div class="text-right pr-5">
      <svg class="border border-gray-300 bg-gray-900 text-gray-100 w-4 h-4 fill-current inline-block absolute -mt-6"><use xlink:href="{% static 'img/svg-defs.svg' %}#clogo"></use></svg>
      </div>
    </div>
  </div>

  <div class="text-center text-gray-700 font-c-sans my-4">
    <div class="inline-flex overflow-hidden border border-gray-300 bg-white shadow rounded-lg">
      {% include 'base/snippets/backbtn.html' with url=essays_url id=essay.slug %}
      {% if request.user.email %}
      <div class="hover:text-black border-l border-gray-300 hover:bg-gray-hover">
        <a href="{% url 'pdf' slug=essay.slug %}" class="flex items-center uppercase text-sm rounded-lg focus:outline-none py-1 px-2" target="_blank">
        <svg class="w-3 h-3 fill-current mr-1"><use xlink:href="{% static 'img/svg-defs.svg' %}#dl"></use></svg> PDF
        </a>
      </div>
      {% endif %}
      {% if next %}
      <div class="hover:text-black border-l border-gray-300 hover:bg-gray-hover">
        <a class="flex items-center uppercase text-sm rounded focus:outline-none py-1 px-2" href="{% url 'read:detail' slug=next.slug %}" data-tippy-content="{{ next.index }}. {{ next.title }}">{% trans 'Next' %}
        <svg class="w-3 h-4 fill-current ml-1" style="transform: scale(-1,1)"><use xlink:href="{% static 'img/svg-defs.svg' %}#arrow"></use></svg></a>
      </div>
      {% endif %}
    </div>
  </div>
  {% include 'base/snippets/cc.html' %}

  {% if request.user.email %}

  <!--{% comment %} if tot_readers % }
  <div class="text-center text-sm text-gray-500">
  <a class="inline-flex items-center" data-tippy-content="Readers"><svg class="w-4 h-4 text-gray-500 fill-current mr-2"><use xlink:href="{% static 'img/svg-defs.svg' %}#reader"></use></svg>
  { { tot_readers } }</a>
  </div>
  { % endif {% endcomment %}-->

  {% if notes.all %}
  <div x-data="{ open: false }">
    <div class="text-center my-4">
      <button @click="open=!open" class="text-sm focus:outline-none items-center border-2 border-yellow-300 shadow p-2 leading-none rounded-lg sc" type="button">
        <p x-show="!open" class="text-center text-sm inline-flex items-center">{% trans 'Show' %} {{ com }} {% trans 'Community Contributions' %}
          <svg class="text-yellow-300 w-4 h-4 ml-2"><use xlink:href="{% static 'img/svg-defs.svg' %}#add"></use></svg>
        </p>
        <p x-show="open" class="text-center text-sm inline-flex items-center">{% trans 'Hide' %}
          <svg class="w-4 h-4 ml-2"><use xlink:href="{% static 'img/svg-defs.svg' %}#remove"></use></svg>
        </p>
      </button>
    </div>
    <div x-show="open" class="font-c-sans border-t border-gray-300 my-5">
      <div class="text-center py-4">
        <span class="text-lg font-c-serif sc py-4">{{ com }} {% trans 'Community Contributions' %}</span>
      </div>
      {% recursetree notes %}
        <div id="{{ node.id }}" class="border border-gray-300 rounded-lg shadow hover:shadow-md p-4 mb-4">
        <div>{{ node.body|safe }}</div>

        <div class="font-c-serif text-xs space-x-2 inline-flex items-center border-t border-gray-300 pt-2 mt-2">
          <span class="italic">— 
          {% if node.private %}
          Anonym
          {% else %}
            {% if node.user.first_name %}
            {{ node.user.first_name|safe }}
            {% else %}
            {{ node.user.email|safe|slice:"-9" }}***
            {% endif %}
          {% endif %}
          </span>
<!--{% comment %} Consider whether add bravo btn <form action="{ % url 'read:like' essay.slug node.id % }" method="POST"> { % csrf_token % }
  <button class="text-xs inline-flex items-center rounded overflow-hidden ring-yellow-100 focus:ring-2 ring-offset-2 ring-offset-transparent focus:outline-none" name="note_id" value="{{ node.id }}" type="submit" data-tippy-content="Bravo">{{ node.tot_likes }}
    <svg class="fill-current h-4 w-4 ml-1"><use xlink:href="{ % static 'img/svg-defs.svg' % }#clap"></use></svg>
  </button>
</form>{% endcomment %}-->
          <span class="sep"></span>
          <span>20{{ node.created_at|date:'Y-m-d' }}</span>
          {% if node.level < 1 %}
          <button class="font-c-sans border border-gray-400 rounded-lg px-2 py-1 shadow hover:shadow-md focus:outline-none" onclick="replyBtn('{{ node.id }}')">{% trans 'Reply' %}</button>
          {% endif %}
        </div>

        {% if not node.is_leaf_node %}
        <div class="items-center overflow-hidden pt-3">
          <div class="absolute text-gray-500 mt-3"><svg class="w-4 h-5 fill-current" style="transform: scale(-1,-1)"><use xlink:href="{% static 'img/svg-defs.svg' %}#reply"></use></svg></div>
          <div class="kid ml-6">{{ children }}</div>
        </div>
        {% endif %}
      </div>
      {% endrecursetree %}
    </div>
  </div>
  {% endif %}
    <!--{% comment %} if there are too many comments add slider if notes.has_other_pages %}
    { % if notes.has_previous %}
    { % endif %}

    { % endif % }
    { % for num in notes.paginator.page_range % }
    { % endfor % }

    { % if notes.number == 1 % }
    { % endif {% endcomment %}-->
    <div class="font-c-sans pt-1 mt-2">
      <form id="id_note_form" method="POST"> {% csrf_token %}
        {{ form.parent }}
        {{ form.body }}
        <div class="text-right items-center space-x-1 my-3"><span class="text-xs" data-tippy-content="Anonym">{% trans 'Check to show your name' %}</span> {{ form.private }}</div>
        <button class="w-full bg-gradient-to-tr to-yellow-300 from-yellow-400 hover:to-yellow-300 hover:from-yellow-500 text-gray-800 border-2 border-yellow-300 hover:border-yellow-400 rounded-lg focus:outline-none focus:ring-2 ring-yellow-200 ring-offset-transparent ring-offset-2 py-1 px-2" type="submit" data-tippy-content="{% trans 'Are you adding value to the Conversation?' %}">
          <p class="text-center text-sm inline-flex items-center">{% trans 'Share' %} <svg class="w-6 h-6 fill-current ml-1" style="transform: scale(-1,1)"><use xlink:href="{% static 'img/svg-defs.svg' %}#post"></use></svg></p>
        </button>
      </form>
    </div>
  {% else %}
  <div class="font-c-sans text-center">
    <p>{% trans 'Eager to share your thoughts?' %}</p>
    <p><a href="{{ register_url }}" class="text-yellow-500 hover:text-yellow-600 font-semibold focus:outline-none">{% trans 'Sign up' %}</a> or <a href="{% url 'login' %}?next={{ request.get_full_path|urlencode }}" class="un font-semibold focus:outline-none">{% trans 'log in' %}</a></p>
  </div>
  {% endif %}
  </div>
</div>
{% endblock %}
{% block js %}
<script>
Sharect.config({
  facebook: false,
  twitter: true,
  twitterUsername: '{{ twit_url }}',
  backgroundColor: 'rgba(0, 0, 0, .6)',
  iconColor: '#fff',
  selectableElements: ['h1', 'h2', 'h3', 'p']
}).init();
function formClose() {
  document.getElementById('id_note_reply').remove()
};
function replyBtn(id) {
  if (document.contains(document.getElementById("id_note_reply"))) {
    document.getElementById("id_note_reply").remove();
  }
  i = parseInt(id);
  var e = document.getElementById(i);
  e.insertAdjacentHTML('afterend', 
   `<div class="font-c-sans mx-6"><form id="id_note_reply" method="POST">{% csrf_token %}
    <div class="text-right"><button type="button" class="text-gray-500 hover:text-gray-700 focus:outline-none rounded-full focus:ring-1 ring-yellow-100 ring-offset-transparent ring-offset-1" onclick="formClose()"><svg class="w-5 h-5" viewBox="0 0 20 20"><g fill="none" fill-rule="evenodd"><circle stroke="currentColor" stroke-width="2" cx="10" cy="10" r="9"/><path fill="currentColor" fill-rule="nonzero" d="m14.982 8.913.035 2-9.999.174-.035-2z"/></g></svg></button></div>
    <select name="parent" id="id_parentt" class="hidden"><option value="' + i + '" selected="' + i + '"></option></select><textarea name="body" cols="30" rows="3" id="comment" placeholder="{% trans 'Are you adding value to the Conversation?' %}" class="hover:border-gray-600 w-full tracking-wide border border-gray-500 rounded-lg text-black py-2 px-3 placeholder-gray-800 hover:shadow-md" type="text" required></textarea>
    <button class="w-full bg-gradient-to-tr to-yellow-300 from-yellow-400 hover:to-yellow-300 hover:from-yellow-500 text-gray-800 border-2 border-yellow-300 hover:border-yellow-400 rounded-lg focus:outline-none focus:ring-1 ring-yellow-200 ring-offset-transparent ring-offset-2 py-1 px-2" type="submit"><p class="text-center text-sm inline-flex items-center">{% trans 'Reply' %} <svg class="w-4 h-4 fill-current ml-1 mb-1" style="transform: scale(-1,1)"><path d="M10.5 5h3a6 6 0 110 12v2.625c-3.75-1.5-9-3.75-9-8.625a6 6 0 016-6zM12 15.5h1.5a4.501 4.501 0 001.722-8.657A4.5 4.5 0 0013.5 6.5h-3A4.5 4.5 0 006 11c0 2.707 1.846 4.475 6 6.36V15.5z"></path></svg></p></button></form></div>`);
};
</script>{% endblock %}<!--{% comment %}<div class="text-right items-center space-x-1 my-3"><span class="text-xs">{% trans 'Check to show your name' %}</span><input type="checkbox" name="private" class="transform hover:scale-110" id="id_private"></div>
FIX if reply->x->all forms are removed and it has to reload page var generalForm = document.getElementById('id_noteForm')// $('#id_note_form').trigger('reset');action="."<div class="text-right items-center space-x-1 my-3"><span class="text-xs">Check to disable replies</span><input type="checkbox" name="reply" class="transform hover:scale-110" id="id_reply"></div>
$('form').preventDoubleSubmission();
jQuery.fn.preventDoubleSubmission = function() {
  $(this).on('submit',function(e){
    var $form = $(this);
    if ($form.data('submitted') === true) {
      e.preventDefault();
    } else {
      $form.data('submitted', true);
    }
  });
  return this;
};
https://calmcode.io/matplot-gif/gif.html less scroll, more slide short text image per page
selector: 'div.tinymce', id="cmt" jQuery plugin to prevent double submission of forms next_url=request.build_absolute_uri ?next={{ request.get_full_path|urlencode }}
add on comments <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>
<script src="{% static 'js/tinymce.m.js' %}"></script>
<script type="text/javascript">
  tinyMCE.init({
    // mode: "textareas",
    selector: 'textarea#cmt',
    //theme: 'simple',
    // plugins: ['quickbars'],
    // toolbar: false,
    // menubar: false,
    // inline: true
  });
</script>{% endcomment %} -->